# .htaccess for Next.js on Hostinger (Non-Standalone Mode)
# This configuration serves static files directly and proxies dynamic routes to Node.js
# Supports both main domain (dudemw.com) and admin subdomain (admin.dudemw.com)

# Force HTTPS
<IfModule mod_rewrite.c>
  RewriteEngine On
  
  # Force HTTPS redirect
  RewriteCond %{HTTPS} off
  RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</IfModule>

# ===== CRITICAL: Set correct MIME types for all file types =====
<IfModule mod_mime.c>
  # JavaScript files - CRITICAL for Next.js chunks
  AddType application/javascript .js
  AddType application/javascript .mjs
  AddType text/javascript .jsx
  
  # JSON files
  AddType application/json .json
  AddType application/json .map
  
  # CSS files
  AddType text/css .css
  
  # Font files
  AddType font/woff2 .woff2
  AddType font/woff .woff
  AddType font/ttf .ttf
  AddType font/otf .otf
  AddType application/font-woff2 .woff2
  AddType application/font-woff .woff
  
  # Image files
  AddType image/webp .webp
  AddType image/svg+xml .svg
  AddType image/png .png
  AddType image/jpeg .jpg .jpeg
  AddType image/gif .gif
  AddType image/x-icon .ico
  
  # Video files
  AddType video/mp4 .mp4
  AddType video/webm .webm
  
  # Other
  AddType application/pdf .pdf
  AddType text/plain .txt
</IfModule>

# ===== Routing Rules: Serve Static Files Directly, Proxy Dynamic Routes =====
<IfModule mod_rewrite.c>
  RewriteEngine On
  
  # Enable rewrite logging for debugging (disable in production)
  # RewriteLog "/tmp/rewrite.log"
  # RewriteLogLevel 3
  
  # Allow .well-known directory (for SSL verification)
  RewriteCond %{REQUEST_URI} ^/.well-known/
  RewriteRule ^(.*)$ $1 [L]
  
  # ===== RULE 1: Serve Next.js static files DIRECTLY (DO NOT PROXY) =====
  # These files are in .next/static/ and should be served by Apache with proper MIME types
  RewriteCond %{REQUEST_URI} ^/_next/static/
  RewriteRule ^(.*)$ - [L]
  
  # ===== RULE 2: Serve public folder files DIRECTLY (DO NOT PROXY) =====
  # Files like favicon.ico, robots.txt, images, etc.
  RewriteCond %{REQUEST_URI} \.(js|mjs|css|json|map|woff2|woff|ttf|otf|eot|svg|png|jpg|jpeg|gif|webp|ico|pdf|txt|xml)$
  RewriteRule ^(.*)$ - [L]
  
  # ===== RULE 3: Serve files that exist on disk DIRECTLY =====
  RewriteCond %{REQUEST_FILENAME} -f
  RewriteRule ^(.*)$ - [L]
  
  # ===== RULE 4: Proxy ALL other requests to Node.js =====
  # This includes:
  # - All page routes (/, /products, /admin/*, etc.)
  # - API routes (/api/*)
  # - Next.js internal routes (_next/data/*, etc.)
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule ^(.*)$ http://127.0.0.1:3000/$1 [P,L,QSA]
</IfModule>

# ===== Proxy Configuration =====
<IfModule mod_proxy.c>
  # Preserve original host header for subdomain detection
  ProxyPreserveHost On
  
  # Pass reverse proxy for Node.js server
  ProxyPassReverse / http://127.0.0.1:3000/
  
  # Timeout settings (increase if needed)
  ProxyTimeout 300
  
  # Pass original headers to Node.js
  RequestHeader set X-Forwarded-Proto "https"
  RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}s"
</IfModule>

# ===== Security Headers =====
<IfModule mod_headers.c>
  # HSTS - Force HTTPS
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
  
  # Prevent clickjacking
  Header always set X-Frame-Options "SAMEORIGIN"
  
  # XSS Protection
  Header always set X-XSS-Protection "1; mode=block"
  
  # Prevent MIME type sniffing - CRITICAL
  Header always set X-Content-Type-Options "nosniff"
  
  # Referrer Policy
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  
  # Content Security Policy (adjust as needed)
  # Header always set Content-Security-Policy "default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' data: https:; connect-src 'self' https:;"
  
  # ===== CRITICAL: Force correct Content-Type headers for JavaScript files =====
  # This ensures browsers execute JS files correctly
  <FilesMatch "\.(js|mjs)$">
    Header always set Content-Type "application/javascript; charset=utf-8"
    Header always set X-Content-Type-Options "nosniff"
  </FilesMatch>
  
  <FilesMatch "\.css$">
    Header always set Content-Type "text/css; charset=utf-8"
  </FilesMatch>
  
  <FilesMatch "\.(json|map)$">
    Header always set Content-Type "application/json; charset=utf-8"
  </FilesMatch>
  
  <FilesMatch "\.(woff2|woff|ttf|otf|eot)$">
    Header always set Access-Control-Allow-Origin "*"
  </FilesMatch>
  
  # Remove X-Powered-By header
  Header always unset X-Powered-By
</IfModule>

# ===== Compression for Better Performance =====
<IfModule mod_deflate.c>
  # Compress HTML, CSS, JavaScript, JSON, XML
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE text/javascript
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/x-javascript
  AddOutputFilterByType DEFLATE application/json
  AddOutputFilterByType DEFLATE application/xml
  AddOutputFilterByType DEFLATE text/xml
  AddOutputFilterByType DEFLATE text/plain
  
  # Compress fonts
  AddOutputFilterByType DEFLATE font/woff2
  AddOutputFilterByType DEFLATE font/woff
  AddOutputFilterByType DEFLATE font/ttf
  AddOutputFilterByType DEFLATE font/otf
  
  # Don't compress images (already compressed)
  SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|webp|ico)$ no-gzip dont-vary
</IfModule>

# ===== Browser Caching for Better Performance =====
<IfModule mod_expires.c>
  ExpiresActive On
  
  # JavaScript and CSS with hashed filenames (_next/static/*) - cache forever
  <FilesMatch "^_next/static/.*\.(js|mjs|css)$">
    ExpiresDefault "access plus 1 year"
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
  
  # Regular JavaScript and CSS - cache for 1 day
  ExpiresByType application/javascript "access plus 1 day"
  ExpiresByType text/javascript "access plus 1 day"
  ExpiresByType text/css "access plus 1 day"
  
  # Images - cache for 1 year
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/x-icon "access plus 1 year"
  
  # Fonts - cache for 1 year
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType font/woff "access plus 1 year"
  ExpiresByType font/ttf "access plus 1 year"
  ExpiresByType font/otf "access plus 1 year"
  ExpiresByType application/font-woff2 "access plus 1 year"
  
  # JSON and Map files - cache for 1 day
  ExpiresByType application/json "access plus 1 day"
  
  # Default - cache for 1 hour
  ExpiresDefault "access plus 1 hour"
</IfModule>

# ===== File Access Control =====
# Disable directory browsing
Options -Indexes

# Prevent access to sensitive files
<FilesMatch "^\.(?!well-known).*">
  <IfModule mod_authz_core.c>
    Require all denied
  </IfModule>
  <IfModule !mod_authz_core.c>
    Order deny,allow
    Deny from all
  </IfModule>
</FilesMatch>

# Protect sensitive files
<FilesMatch "\.(env|log|sql|md|json|lock)$">
  <IfModule mod_authz_core.c>
    Require all denied
  </IfModule>
  <IfModule !mod_authz_core.c>
    Order deny,allow
    Deny from all
  </IfModule>
</FilesMatch>

# ===== Character Encoding =====
AddDefaultCharset UTF-8
<IfModule mod_mime.c>
  AddCharset UTF-8 .html .css .js .mjs .json .xml .txt
</IfModule>

# ===== Error Pages (Optional) =====
# ErrorDocument 404 /404.html
# ErrorDocument 500 /500.html
